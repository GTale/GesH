/**
 * 判断元素是否可见
 */
function isVisible(element) {
  if (!element || element.nodeType !== 1) return false;
  
  const style = window.getComputedStyle(element);
  return style.display !== 'none' && 
         style.visibility !== 'hidden' && 
         style.opacity !== '0' &&
         element.offsetWidth > 0 &&
         element.offsetHeight > 0;
}

/**
 * 获取元素的直接文本内容（不包括子元素文本）
 */
function getDirectText(element) {
  let text = '';
  
  // 遍历所有子节点
  for (const node of element.childNodes) {
    if (node.nodeType === 3) { // 文本节点
      const trimmed = node.textContent.trim();
      if (trimmed) {
        text += (text ? ' ' : '') + trimmed;
      }
    }
  }
  
  return text || '*'; // 如果没有文本，返回 '*'
}

/**
 * 深度遍历DOM，生成目录结构
 */
function generateDOMDirectory(root, depth = 0) {
  const result = [];
  const indent = '  '.repeat(depth);
  
  // 只处理元素节点，且必须是可见的
  if (root.nodeType === 1 && isVisible(root)) {
    // 获取当前节点的直接文本
    const nodeText = getDirectText(root);
    
    // 获取所有可见的子元素
    const childElements = Array.from(root.children || [])
      .filter(child => child.nodeType === 1 && isVisible(child));
    
    if (childElements.length === 0) {
      // 叶子节点，直接添加文本
      result.push(`${indent}${nodeText}`);
    } else {
      // 检查所有子节点是否都是叶子节点
      const allChildrenAreLeaves = childElements.every(child => {
        const grandChildren = Array.from(child.children || [])
          .filter(gc => gc.nodeType === 1 && isVisible(gc));
        return grandChildren.length === 0;
      });
      
      if (allChildrenAreLeaves) {
        // 所有子节点都是叶子节点，用 - 连接它们的文本
        const leafTexts = childElements.map(child => getDirectText(child));
        const combinedText = leafTexts.join('-');
        result.push(`${indent}${nodeText}`);
        if (combinedText) {
          result.push(`${indent}  ${combinedText}`);
        }
      } else {
        // 有嵌套的子节点，递归处理
        result.push(`${indent}${nodeText}`);
        childElements.forEach(child => {
          result.push(...generateDOMDirectory(child, depth + 1));
        });
      }
    }
  }
  
  return result;
}

/**
 * 生成并打印目录结构
 */
function printDOMDirectory() {
  console.log('DOM目录结构:');
  console.log('============');
  
  try {
    // 从body开始遍历，或者你可以指定其他根节点
    const rootElement = document.body;
    const directory = generateDOMDirectory(rootElement);
    
    directory.forEach(line => console.log(line));
    
    console.log('============');
    console.log('目录生成完成');
  } catch (error) {
    console.error('生成目录时出错:', error);
  }
}

// 使用示例：
// 可以直接调用 printDOMDirectory() 来生成目录
// 或者绑定到某个事件上

// 示例调用 - 可以直接在控制台运行
// printDOMDirectory();