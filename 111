Add-Type -TypeDefinition @"\
using System;\
using System.Runtime.InteropServices;\
\
public class MSAAInterop {\
    [DllImport("oleacc.dll")]\
    public static extern int ObjectFromLresult(\
        int lResult, \
        ref Guid riid, \
        int wParam, \
        out IHTMLDocument2 ppvObject\
    );\
    \
    [DllImport("user32.dll", SetLastError = true)]\
    public static extern int SendMessage(\
        IntPtr hWnd, \
        uint Msg, \
        int wParam, \
        int lParam\
    );\
    \
    [DllImport("user32.dll", SetLastError = true)]\
    public static extern uint RegisterWindowMessage(string lpString);\
}\
\
[ComImport, Guid("626FC520-A41E-11CF-A731-00A0C9082637"), InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]\
public interface IHTMLDocument2 {\
    // 精简声明关键接口方法\
    void dummy(); // 实际使用需补充完整声明\
}\
"@ -ReferencedAssemblies "Microsoft.mshtml"

# 获取目标窗口句柄 (替换为实际HWND)
$hWnd = [IntPtr]0x000A0B0C  # 示例值，需替换为实际句柄

# 注册WM_HTML_GETOBJECT消息
$WM_HTML_GETOBJECT = [MSAAInterop]::RegisterWindowMessage("WM_HTML_GETOBJECT")

# 发送消息获取对象引用
$lResult = [MSAAInterop]::SendMessage($hWnd, $WM_HTML_GETOBJECT, 0, 0)

if ($lResult -ne 0) {
    # 定义IHTMLDocument2的GUID
    $IID_IHTMLDocument = [Guid]::new("626FC520-A41E-11CF-A731-00A0C9082637")
    
    # 获取文档对象
    $doc = $null
    [MSAAInterop]::ObjectFromLresult($lResult, [ref]$IID_IHTMLDocument, 0, [ref]$doc) | Out-Null
    
    if ($null -ne $doc) {
        # 访问文档属性
        Write-Host "成功获取IHTMLDocument2对象！"
        Write-Host "页面标题: $($doc.title)"
        Write-Host "URL: $($doc.url)"
        
        # 示例：获取body内容
        $bodyHtml = $doc.body.outerHTML.Substring(0, [Math]::Min(100, $doc.body.outerHTML.Length))
        Write-Host "Body预览: $bodyHtml..."
    } else {
        Write-Error "获取文档对象失败，请检查窗口句柄和IE模式状态"
    }
} else {
    Write-Error "WM_HTML_GETOBJECT消息未返回有效结果"
}
