Add-Type @"\
using System;\
using System.Runtime.InteropServices;\
\
public class IEAccess {\
    // 导入 Windows API\
    [DllImport("oleacc.dll")]\
    public static extern int AccessibleObjectFromWindow(\
        IntPtr hwnd, uint id, ref Guid iid, [Out, MarshalAs(UnmanagedType.IUnknown)] out object ptr\
    );\
    \
    // IHTMLDocument2 的 GUID\
    public static readonly Guid IID_IHTMLDocument = new Guid("626FC520-A41E-11CF-A731-00A0C9082637");\
    \
    // 获取文档对象\
    public static mshtml.IHTMLDocument2 GetDocumentFromHWND(IntPtr hwnd) {\
        object obj = null;\
        int hr = AccessibleObjectFromWindow(\
            hwnd, \
            0, \
            ref IID_IHTMLDocument, \
            out obj\
        );\
        if (hr != 0 || obj == null) return null;\
        return (mshtml.IHTMLDocument2)obj;\
    }\
}\
"@ -ReferencedAssemblies "Microsoft.mshtml"

# 1. 获取 IE 窗口句柄
$ieProcess = Get-Process | Where-Object { $_.ProcessName -eq "iexplore" }
if (-not $ieProcess) { throw "未找到运行中的 IE 进程" }

# 2. 遍历窗口获取文档对象
$ieProcess | ForEach-Object {
    $hwnd = $_.MainWindowHandle
    if ($hwnd -ne [IntPtr]::Zero) {
        try {
            $doc = [IEAccess]::GetDocumentFromHWND($hwnd)
            if ($doc) {
                Write-Host "成功获取文档对象，当前 URL: $($doc.url)"
                # 3. 操作 DOM 示例
                $searchBox = $doc.getElementById("searchInput")
                if ($searchBox) { $searchBox.value = "PowerShell 修改内容" }
            }
        } catch { Write-Warning "窗口 $hwnd 操作失败: $_" }
    }
}
